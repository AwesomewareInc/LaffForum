{{ template "header.html" .}}

{{ $verificationErrors := "" }}

{{if eq (len .Values) 0}}
	you have me nothing you fuckwad
{{else}}
	{{$postid := HTMLEscape (index .Values 1)}}
	{{$post := GetPostInfo $postid}}
	{{if $post.Error}}
		{{HTMLEscape $post.Error.Error}}
	{{else if ne $post.ReplyTo 0}}
		<script>
			window.open("/post/{{HTMLEscape $post.ReplyTo}}#{{HTMLEscape $post.ID}}","_self");
		</script>
	{{else}}
		{{if eq $post.ID 0}}
			<h1>Non-existent post.</h1>
		{{else}}

			{{$sectioninf := GetSectionInfo $post.Topic}}
			{{if $sectioninf.Error}}
				{{$sectioninf.Error.Error}}
			{{else}}
				{{$content := HTMLEscape (.Query.Get "contents")}}
				{{if ge (len $content) 1}}
					{{$allowed := true}}
					{{if (eq $sectioninf.AdminOnly 2)}}
						{{if not .Global.Admin}}
							{{$allowed = false}}
						{{end}}
					{{else if not .Global.Username}}
						{{$allowed = false}}
					{{end}}
					{{if $allowed}}
						{{$reply := SubmitPost .Global.Username (HTMLEscape $post.Topic) (HTMLEscape (print "RE: " $post.Subject)) $content $post.ID}}
						{{if $reply.Error}}
							<h1>Error while submitting your post.</h1>
							<span style="white-space: pre-wrap">{{$reply.Error}}</span>
						{{else}}
							<script>
								window.open("/post/{{$post.Topic}}","_self");
							</script>		
						{{end}}
					{{else}}
						<h1>Permission denied</h1>
					{{end}}
				{{end}}
			{{end}}

			<span class='vbox'>
				<span class='hbox'>
					<span class='box authorbox'>
						{{$author := GetUsernameByID $post.Author}}
						{{if $author.Error}}
							Could not get author; {{$author.Error.Error}}
						{{else}}
							Post by <a href='/user/{{$author.Result}}/'>{{$author.Result}}</a><br>
						{{end}}
						<br>
						{{$timestamp := PrettyTime $post.Timestamp}}
						{{if $timestamp.Error}}
							Couldn't get timestamp; {{$timestamp.Error.Error}}
						{{else}}
							<small style='font-weight: normal;'>posted {{$timestamp.Result}}</small>
						{{end}}
					</span>
					<span class='box postinfo'>
						<h1>{{Markdown $post.Subject}}</h1>
						{{Markdown $post.Contents}}
					</span>
				</span>
				{{if .Global.Username}}
					<form class='vbox' method='post'>
						<span style='flex: 4' class='hbox'>
							{{if eq $sectioninf.AdminOnly 2}}
								{{if .Global.Me.Admin}}
									<textarea rows='5' style='flex: 4' name='contents' placeholder='Reply'></textarea>
									<h3>{{$verificationErrors}}</h3>
									<input style='flex: 1' type= 'submit' value='Post'>
								{{end}}
							{{else}}
								<textarea rows='5' style='flex: 4' name='contents' placeholder='Reply'></textarea>
								<h3>{{$verificationErrors}}</h3>
								<input style='flex: 1' type='submit' value='Post'>
							{{end}}
						</span>
						<span class='vbox'>
							<div style='align-self:flex-end' class="h-captcha" data-sitekey="172337d6-4a4e-447a-af25-4be55354bd60"></div>
						</span>
					</form>
				{{end}}
			</span>
			<hr>
			<table class='replies'>
				<tbody>
				{{template "replies.html" $post.ID}}
				{{end}}
				</tbody>
			</table>
		{{end}}
	{{end}}
{{ template "footer.html" .}}